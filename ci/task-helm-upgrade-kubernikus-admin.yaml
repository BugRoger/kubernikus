---
platform: 'linux'

image_resource:
  type: docker-image
  source:
    repository: hub.global.cloud.sap/monsoon/kubectl
    tag: 'v1.7.7'

inputs:
  - name: kubernikus.git
  - name: secrets.git
  - name: kubernikus.image

run:
  path: /bin/sh
  args:
    - -c
    - |
      set -exo pipefail
      VERSION=$(cat kubernikus.image/tag)
      helm dep up --skip-refresh kubernikus.git/charts/kubernikus/
      helm upgrade $KUBERNIKUS_NAME kubernikus.git/charts/kubernikus/ --values secrets.git/admin/values/$KUBERNIKUS_NAME.yaml --set imageTag=$VERSION --install
      kubectl rollout status deployment/kubernikus-api --namespace=$KUBERNIKUS_NAME
      kubectl rollout status deployment/kubernikus-operator --namespace=$KUBERNIKUS_NAME

params:
  KUBERNIKUS_NAME:
  GITHUB_TOKEN:
