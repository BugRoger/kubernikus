---
platform: 'linux'

image_resource:
  type: docker-image
  source:
    repository: hub.global.cloud.sap/monsoon/kubectl
    tag: 'v1.4.6'

inputs:
  - name: kubernikus.git
  - name: secrets.git

run:
  path: /bin/sh
  args:
    - -c
    - |
      set -exo pipefail
      helm upgrade kubernikus kubernikus.git/charts/kube-master/ --values secrets.git/$REGION/values/kubernikus.yaml
      kubectl get deployments --namespace=$NAMESPACE -o jsonpath='{.items[*].metadata.name}' | tr ' ' '\n' | while read DEPLOYMENT; do
        kubectl rollout status deployment/"$DEPLOYMENT" --namespace=$NAMESPACE
      done
      set +x
      kubectl get deployments --namespace=$NAMESPACE -o jsonpath='{.items[*].metadata.name}' | tr ' ' '\n' | while read DEPLOYMENT; do
        echo "Waiting for $DEPLOYMENT deployment to succeed"
        until kubectl get deployment "$DEPLOYMENT" --namespace=$NAMESPACE -o json | \
                jq -e '.status | .unavailableReplicas == null and .replicas == .updatedReplicas' >/dev/null; do
          if [ $TIMEOUT -le 0 ]; then echo -e "\nTimeout waiting for deployment: $DEPLOYMENT"; exit 1; fi
          TIMEOUT=$((TIMEOUT-STEP))
          sleep $STEP
          printf .
        done
      done
      echo -e "\nDeployment completed"

params:
  STEP: 2
  TIMEOUT: 300
  NAMESPACE: kube-system
  REGION:
  GITHUB_TOKEN:
